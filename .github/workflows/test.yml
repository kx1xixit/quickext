name: Validate extension

on:
  push:
    branches: [main, develop, master]
  pull_request:
    branches: [main, develop, master]

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - uses: actions/checkout@v6

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: npm run build

      - name: Verify syntax
        run: |
          node -c build/extension.js
          echo "Extension syntax is valid"

      - name: Check extension structure
        run: |
          node << 'EOF'
          const fs = require('fs');
          const content = fs.readFileSync('build/extension.js', 'utf8');

          const checks = {
            'Extension header (// Name:)': /^\/\/ Name:/m,
            'IIFE function': /\(function\s*\(\s*Scratch\s*\)/m,
            'Class definition': /class\s+\w+\s*\{/,
            'getInfo method': /getInfo\s*\(\s*\)\s*\{/,
            'Extension registration': /Scratch\.extensions\.register/,
            'Closing IIFE': /\}\)\(Scratch\);$/m,
          };

          console.log('Checking extension structure...\n');
          let allPass = true;

          for (const [check, pattern] of Object.entries(checks)) {
            if (pattern.test(content)) {
              console.log(`[PASS] ${check}`);
            } else {
              console.log(`[FAIL] ${check}`);
              allPass = false;
            }
          }

          if (!allPass) {
            process.exit(1);
          }

          console.log('\nAll structure checks passed');
          EOF
