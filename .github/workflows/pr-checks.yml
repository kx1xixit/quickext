name: PR Checks

on:
  pull_request:
    branches: [main, develop, master]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-pr:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR Title
        uses: actions/github-script@v8
        with:
          script: |
            const title = context.payload.pull_request.title;
            const validPatterns = [
              /^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?:/,
              /^(Feature|Fix|Docs|Style|Refactor|Performance|Test|Chore):/,
              /^(\d+\.)?\d+\.\d+/, // Version numbers
            ];

            const isValid = validPatterns.some(pattern => pattern.test(title));

            if (!isValid) {
              core.warning(`PR title doesn't follow conventional commits format: "${title}"`);
            }

      - name: Check PR Description
        uses: actions/github-script@v8
        with:
          script: |
            const body = context.payload.pull_request.body;
            if (!body || body.trim().length === 0) {
              core.warning('PR description is empty. Please add details about your changes.');
            }

      - name: Check for Commits
        uses: actions/github-script@v8
        with:
          script: |
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            if (commits.data.length === 0) {
              core.setFailed('PR has no commits');
            }

  build-validation:
    needs: validate-pr
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: npm run build

      - name: Verify Extension Output
        run: |
          if [ ! -f build/extension.js ]; then
            echo "[FAIL] Build failed: extension.js not found"
            exit 1
          fi

          # Check file size
          SIZE=$(wc -c < build/extension.js)
          echo "[PASS] Extension built successfully (${SIZE} bytes)"

          # Verify it's valid JavaScript
          node -c build/extension.js && echo "[PASS] Valid JavaScript syntax"

      - name: Run Linter
        run: npm run lint
        continue-on-error: true

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-${{ matrix.node-version }}
          path: build/extension.js
          retention-days: 7

      - name: Comment PR with Results
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const size = fs.statSync('build/extension.js').size;
            const sizeKB = (size / 1024).toFixed(2);

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `Build Report (Node ${{ matrix.node-version }})

            [PASS] Extension built successfully
            - File size: ${sizeKB} KB
            - Valid JavaScript syntax
            - Ready for testing

            Download artifact: [extension-${{ matrix.node-version }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            });
